[test-case]

"RDAP RTT"

[prepare-server-database]

[set-global-macro]

"{$RSM.MONITORING.TARGET}","registry"
"{$RSM.IP4.ROOTSERVERS1}","193.0.14.129,192.5.5.241,199.7.83.42,198.41.0.4,192.112.36.4"
"{$RSM.IP6.ROOTSERVERS1}","2001:7fe::53,2001:500:2f::f,2001:500:9f::42,2001:503:ba3e::2:30,2001:500:12::d0d"
"{$RSM.DNS.PROBE.ONLINE}","2"
"{$RSM.RDDS.PROBE.ONLINE}","2"
"{$RSM.RDAP.PROBE.ONLINE}","2"
"{$RSM.IP4.MIN.PROBE.ONLINE}","2"
"{$RSM.IP6.MIN.PROBE.ONLINE}","2"
"{$RSM.RDAP.STANDALONE}","1609459200"

# override RTT macros
"{$RSM.RDAP.RTT.LOW}","700"

[provisioning-api]

"/probeNodes/Probe1-Server1","PUT",200,"readwrite","000-input-probe1.json",""
"/probeNodes/Probe2-Server1","PUT",200,"readwrite","000-input-probe2.json",""

# main TLD
"/tlds/tld1","PUT",200,"readwrite","000-input-tld1-rdap.json",""

# reconfigured TLD
"/tlds/tld2","PUT",200,"readwrite","000-input-tld2-rdap.json",""

# disabled TLD
"/tlds/tld3","PUT",200,"readwrite","000-input-tld3-rdap.json",""

[set-host-macro]

"Template Rsmhost Config tld2","{$RSM.TLD.CONFIG.TIMES}",1617233430

[update-rsm-conf]

"slv","reconfig_duration",10

[fill-history]

"tld1 Probe1-Server1","rdap.rtt",300,"2021-03-31 19:00:00",999,101,102,103,999,105,106,107,108,109,999,111,112,113,999,115,116,117,118,119,999,121,122,123,999,125,126,127,128,129,999,131,132,133,999,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,-405,+161,+162,+163,+164
"tld1 Probe2-Server1","rdap.rtt",300,"2021-03-31 19:00:00",200,999,202,203,999,205,206,207,208,209,210,999,212,213,999,215,216,217,218,219,220,999,222,223,999,225,226,227,228,229,230,999,232,233,999,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,-300,-405,-500,-600,-700

"tld2 Probe1-Server1","rdap.rtt",300,"2021-03-31 19:00:00",100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164
"tld2 Probe2-Server1","rdap.rtt",300,"2021-03-31 19:00:00",200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264

"tld3 Probe1-Server1","rdap.rtt",300,"2021-03-31 19:00:00",100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164
"tld3 Probe2-Server1","rdap.rtt",300,"2021-03-31 19:00:00",200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264

[fix-lastvalue-tables]

[start-server]

"2021-01-23 00:00:00"

[execute]

"2021-03-31 23:50:00","/opt/zabbix/scripts/slv/rsm.slv.rdap.rtt.pl --nolog --cycles 30"

[fill-history]

"tld3","rsm.slv.dns.downtime"                         ,60,0,1
"tld3","rsm.slv.dns.ns.downtime[ns1.tld3,192.168.3.1]",60,0,1
"tld3","rsm.slv.dns.tcp.rtt.pfailed"                  ,60,0,1
"tld3","rsm.slv.dns.udp.rtt.pfailed"                  ,60,0,1

[execute-sql-query]

"update history      set clock=floor(unix_timestamp()/300)*300 where clock=0"
"update history_uint set clock=floor(unix_timestamp()/300)*300 where clock=0"

[provisioning-api]

"/tlds/tld3","PUT",200,"readwrite","000-input-tld-disabled.json",""

[execute]

"2021-04-01 01:00:00","/opt/zabbix/scripts/slv/rsm.slv.rdap.rtt.pl --nolog --cycles 120"

[stop-server]

[compare-history]

"tld1","rsm.slv.rdap.rtt.performed",300,"2021-03-31 18:35:00",,,,,,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,1,3,4,5,6,6,6
"tld1","rsm.slv.rdap.rtt.failed"   ,300,"2021-03-31 18:35:00",,,,,,1,2,2,2,4,4,4,4,4,4,5,6,6,6,8,8,8,8,8,8,9,10,10,10,12,12,12,12,12,12,13,14,14,14,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,1,2,2,2,2,2,2
"tld1","rsm.slv.rdap.rtt.pfailed"  ,300,"2021-03-31 18:35:00",,,,,,0.833,1.667,1.667,1.667,3.333,3.333,3.333,3.333,3.333,3.333,4.167,5.000,5.000,5.000,6.667,6.667,6.667,6.667,6.667,6.667,7.500,8.333,8.333,8.333,10.000,10.000,10.000,10.000,10.000,10.000,10.833,11.667,11.667,11.667,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,0.0058,0.0116,0.0116,0.0116,0.0116,0.0116,0.0116

"tld2","rsm.slv.rdap.rtt.performed",300,"2021-03-31 18:35:00",,,,,,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,108,108,110,112,114,116,2,4,6,8,10,10,10
"tld2","rsm.slv.rdap.rtt.failed"   ,300,"2021-03-31 18:35:00",,,,,,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
"tld2","rsm.slv.rdap.rtt.pfailed"  ,300,"2021-03-31 18:35:00",,,,,,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0

"tld3","rsm.slv.rdap.rtt.performed",300,"2021-03-31 18:35:00",,,,,,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,,
"tld3","rsm.slv.rdap.rtt.failed"   ,300,"2021-03-31 18:35:00",,,,,,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,,
"tld3","rsm.slv.rdap.rtt.pfailed"  ,300,"2021-03-31 18:35:00",,,,,,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,,

[check-incident]

# 10%  - 0.50%
# 25%  - 1.25%
# 50%  - 2.50%
# 75%  - 3.75%
# 100% - 5.00%

"tld1","Ratio of failed RDAP tests exceeded 10% of allowed $1%" ,"2021-03-31 19:00:00","2021-04-01 00:00:00"
"tld1","Ratio of failed RDAP tests exceeded 25% of allowed $1%" ,"2021-03-31 19:05:00","2021-04-01 00:00:00"
"tld1","Ratio of failed RDAP tests exceeded 50% of allowed $1%" ,"2021-03-31 19:20:00","2021-04-01 00:00:00"
"tld1","Ratio of failed RDAP tests exceeded 75% of allowed $1%" ,"2021-03-31 19:50:00","2021-04-01 00:00:00"
"tld1","Ratio of failed RDAP tests exceeded 100% of allowed $1%","2021-03-31 20:10:00","2021-04-01 00:00:00"

[check-event-count]

"tld1","Ratio of failed RDAP tests exceeded 10% of allowed $1%",2
"tld1","Ratio of failed RDAP tests exceeded 25% of allowed $1%",2
"tld1","Ratio of failed RDAP tests exceeded 50% of allowed $1%",2
"tld1","Ratio of failed RDAP tests exceeded 75% of allowed $1%",2
"tld1","Ratio of failed RDAP tests exceeded 100% of allowed $1%",2
