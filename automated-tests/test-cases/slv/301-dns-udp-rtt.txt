[test-case]

"301 DNS UDP RTT"

[prepare-server-database]

[set-global-macro]

"{$RSM.MONITORING.TARGET}","registry"
"{$RSM.IP4.ROOTSERVERS1}","193.0.14.129,192.5.5.241,199.7.83.42,198.41.0.4,192.112.36.4"
"{$RSM.IP6.ROOTSERVERS1}","2001:7fe::53,2001:500:2f::f,2001:500:9f::42,2001:503:ba3e::2:30,2001:500:12::d0d"
"{$RSM.DNS.PROBE.ONLINE}","2"
"{$RSM.RDDS.PROBE.ONLINE}","2"
"{$RSM.RDAP.PROBE.ONLINE}","2"
"{$RSM.IP4.MIN.PROBE.ONLINE}","2"
"{$RSM.IP6.MIN.PROBE.ONLINE}","2"
"{$RSM.RDAP.STANDALONE}","1609459200"

# override RTT macros
"{$RSM.DNS.UDP.RTT.LOW}","700"

[create-probe]

"Probe1-Server1","127.0.0.1","10061",1,1,1,1
"Probe2-Server1","127.0.0.1","10062",1,1,1,1

[create-tld]

# TLD with one NS,IP being disabled
"tld1","test","ccTLD",1,1,1,"ns1.tld1,192.168.1.1 ns2.tld1,192.168.1.2 ns3.tld1,192.168.1.3","","","","","",""

# reconfigured TLD
"tld2","test","ccTLD",1,1,1,"ns1.tld2,192.168.2.1","","","","","",""

# disabled TLD
"tld3","test","ccTLD",1,1,1,"ns1.tld3,192.168.3.1","","","","","",""

[set-host-macro]

"Template Rsmhost Config tld2","{$RSM.TLD.CONFIG.TIMES}",1617233430

[update-rsm-conf]

"slv","reconfig_duration",10

[fill-history]

"tld1 Probe1-Server1","rsm.dns.rtt[ns1.tld1,192.168.1.1,udp]",60,"2021-03-31 23:00:00",999,101,102,103,104,105,999,107,108,999,110,999,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,999,131,132,133,134,135,999,137,138,999,140,999,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,-200,+161,+162,+163,+164
"tld1 Probe2-Server1","rsm.dns.rtt[ns1.tld1,192.168.1.1,udp]",60,"2021-03-31 23:00:00",200,999,202,203,204,205,999,207,208,999,210,999,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,999,232,233,234,235,999,237,238,999,240,999,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,-300,-400,-500,-600,-700

"tld1 Probe1-Server1","rsm.dns.rtt[ns2.tld1,192.168.1.2,udp]",60,"2021-03-31 23:00:00",300,301,999,303,304,305,306,999,308,999,310,999,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,999,333,334,335,336,999,338,999,340,999,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,+360,-200,+362,+363,+364
"tld1 Probe2-Server1","rsm.dns.rtt[ns2.tld1,192.168.1.2,udp]",60,"2021-03-31 23:00:00",400,401,402,999,404,405,406,999,408,409,999,999,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,999,434,435,436,999,438,439,999,999,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,,,,,

"tld1 Probe1-Server1","rsm.dns.rtt[ns3.tld1,192.168.1.3,udp]",60,"2021-03-31 23:00:00",500,501,502,503,999,505,506,507,999,509,999,999,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,999,535,536,537,999,539,999,999,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,+560,+561,-200,+563,+564
"tld1 Probe2-Server1","rsm.dns.rtt[ns3.tld1,192.168.1.3,udp]",60,"2021-03-31 23:00:00",600,601,602,603,604,999,606,607,999,609,999,999,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,999,636,637,999,639,999,999,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,,,,,

"tld2 Probe1-Server1","rsm.dns.rtt[ns1.tld2,192.168.2.1,udp]",60,"2021-03-31 23:00:00",100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164
"tld2 Probe2-Server1","rsm.dns.rtt[ns1.tld2,192.168.2.1,udp]",60,"2021-03-31 23:00:00",200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264

"tld3 Probe1-Server1","rsm.dns.rtt[ns1.tld3,192.168.3.1,udp]",60,"2021-03-31 23:00:00",100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164
"tld3 Probe2-Server1","rsm.dns.rtt[ns1.tld3,192.168.3.1,udp]",60,"2021-03-31 23:00:00",200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264

[fix-lastvalue-tables]

[start-server]

"2021-01-23 00:00:00"

[execute]

"2021-03-31 23:50:00","/opt/zabbix/scripts/slv/rsm.slv.dns.udp.rtt.pl --nolog --cycles 30"

[create-tld]

"tld1","test","ccTLD",1,1,1,"ns1.tld1,192.168.1.1 ns2.tld1,192.168.1.2","","","","","",""

[disable-tld]

"tld3"

[execute]

"2021-04-01 01:00:00","/opt/zabbix/scripts/slv/rsm.slv.dns.udp.rtt.pl --nolog --cycles 120"

[stop-server]

[compare-history]

"tld1","rsm.slv.dns.udp.rtt.performed",60,"2021-03-31 22:55:00",,,,,,6,12,18,24,30,36,42,48,54,60,66,72,78,84,90,96,102,108,114,120,126,132,138,144,150,156,162,168,174,180,184,188,192,196,200,204,208,212,216,220,224,228,232,236,240,244,248,252,256,260,264,268,272,276,280,284,288,292,296,300,2,4,6,8,10,10,10
"tld1","rsm.slv.dns.udp.rtt.failed"   ,60,"2021-03-31 22:55:00",,,,,,1,2,3,4,5,6,8,10,12,15,18,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,26,27,28,28,28,30,32,32,35,36,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,1,2,2,2,2,2,2
"tld1","rsm.slv.dns.udp.rtt.pfailed"  ,60,"2021-03-31 22:55:00",,,,,,0.278,0.556,0.833,1.111,1.389,1.667,2.222,2.778,3.333,4.167,5.000,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,6.667,8.333,8.667,9.000,9.333,9.333,9.333,10.000,10.667,10.667,11.667,12.000,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,13.333,0.001,0.001,0.001,0.001,0.001,0.001,0.001

"tld2","rsm.slv.dns.udp.rtt.performed",60,"2021-03-31 22:55:00",,,,,,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,60,60,60,60,60,60,60,60,60,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,2,4,6,8,10,10,10
"tld2","rsm.slv.dns.udp.rtt.failed"   ,60,"2021-03-31 22:55:00",,,,,,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
"tld2","rsm.slv.dns.udp.rtt.pfailed"  ,60,"2021-03-31 22:55:00",,,,,,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0

"tld3","rsm.slv.dns.udp.rtt.performed",60,"2021-03-31 22:55:00",,,,,,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,,
"tld3","rsm.slv.dns.udp.rtt.failed"   ,60,"2021-03-31 22:55:00",,,,,,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,,
"tld3","rsm.slv.dns.udp.rtt.pfailed"  ,60,"2021-03-31 22:55:00",,,,,,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,,

[check-incident]

# 10%  - 0.50%
# 25%  - 1.25%
# 50%  - 2.50%
# 75%  - 3.75%
# 100% - 5.00%

"tld1","Ratio of failed DNS UDP tests exceeded 10% of allowed $1%" ,"2021-03-31 23:01:00","2021-04-01 00:00:00"
"tld1","Ratio of failed DNS UDP tests exceeded 25% of allowed $1%" ,"2021-03-31 23:04:00","2021-04-01 00:00:00"
"tld1","Ratio of failed DNS UDP tests exceeded 50% of allowed $1%" ,"2021-03-31 23:07:00","2021-04-01 00:00:00"
"tld1","Ratio of failed DNS UDP tests exceeded 75% of allowed $1%" ,"2021-03-31 23:09:00","2021-04-01 00:00:00"
"tld1","Ratio of failed DNS UDP tests exceeded 100% of allowed $1%","2021-03-31 23:11:00","2021-04-01 00:00:00"

[check-event-count]

"tld1","Ratio of failed DNS UDP tests exceeded 10% of allowed $1%",2
"tld1","Ratio of failed DNS UDP tests exceeded 25% of allowed $1%",2
"tld1","Ratio of failed DNS UDP tests exceeded 50% of allowed $1%",2
"tld1","Ratio of failed DNS UDP tests exceeded 75% of allowed $1%",2
"tld1","Ratio of failed DNS UDP tests exceeded 100% of allowed $1%",2
